<!DOCTYPE html>
<html>
<head>
    <title>BlastDown</title>

    <script type="text/javascript" src="/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"rallysolrartifactchooserdialog",id:"portfolioItemPicker",artifactTypes:["portfolioitem/initiative"],autoShow:!0,height:250,title:"Choose an Initiative",listeners:{artifactChosen:function(picker,selectedRecord){App._getArtifacts(selectedRecord)},scope:this}}],launch:function(){App=this},_getArtifacts:function(scope){var hierarchy=scope.get("ObjectID");console.log("Querying lbAPI for artifacts under "+hierarchy),aggregateData={initiative:scope.data,features:{},storiesAndDefects:{},parentless:[]};var tasks=[];Ext.getBody().mask("Loading"),Ext.create("Rally.data.lookback.SnapshotStore",{listeners:{load:function(store,data,success){Ext.Array.each(data,function(artifact){var types=artifact.raw._TypeHierarchy;switch(types[types.length-1]){case"Defect":aggregateData.storiesAndDefects[artifact.data.ObjectID]={artifact:artifact.raw,children:[]};break;case"HierarchicalRequirement":aggregateData.storiesAndDefects[artifact.data.ObjectID]={artifact:artifact.raw,children:[]};break;case"PortfolioItem/Feature":aggregateData.features[artifact.data.ObjectID]={feature:artifact.raw,children:[]};break;case"Task":Ext.Array.push(tasks,artifact.raw);break;default:}});var organizedData=App._organizeData(aggregateData);console.log(organizedData),Ext.getBody().unmask()}},fetch:!0,hydrate:["ScheduleState","State","_TypeHierarchy"],findConfig:{_ItemHierarchy:hierarchy,__At:"current"}}).load()},_organizeData:function(aggregateData){var organizedData={initiative:aggregateData.initiative,features:{}};return Ext.Array.each(tasks,function(task){var parent=task.WorkProduct;aggregateData.storiesAndDefects[parent]?Ext.Array.push(aggregateData.storiesAndDefects[parent].children,task):console.log("not parented to a story or defect",task)}),Ext.Object.each(aggregateData.storiesAndDefects,function(oid,object){var parent,types=object.artifact._TypeHierarchy;if("HierarchicalRequirement"===types[types.length-1])parent=object.artifact.PortfolioItem;else{var requirement=aggregateData.storiesAndDefects[object.artifact.Requirement];requirement?parent=requirement.artifact.PortfolioItem:console.log("not found",object)}aggregateData.features[parent]?Ext.Array.push(aggregateData.features[parent].children,object):console.log("not parented to a feature")}),organizedData[features]=aggregateData[features],organizedData}});

            Rally.launchApp('CustomApp', {
                name:"BlastDown",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body></body>
</html>
